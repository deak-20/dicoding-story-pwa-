const CACHE_NAME="dicoding-story-v1",DATA_CACHE_NAME="dicoding-story-data-v1",urlsToCache=["/","/index.html","/app.bundle.js","/images/icon-192x192.png","/images/icon-512x512.png","/favicon.png"];async function syncOfflineStories(){console.log("[Service Worker] Syncing offline stories...");try{const e=await openDB(),o=e.transaction("pending-stories","readonly").objectStore("pending-stories"),t=await o.getAll();console.log("[Service Worker] Found pending stories:",t.length);for(const o of t)try{const t=new FormData;if(t.append("description",o.description),t.append("photo",o.photo),o.lat&&t.append("lat",o.lat),o.lon&&t.append("lon",o.lon),(await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${o.token}`},body:t})).ok){const t=e.transaction("pending-stories","readwrite").objectStore("pending-stories");await t.delete(o.id),console.log("[Service Worker] Story synced successfully:",o.id)}}catch(e){console.error("[Service Worker] Error syncing story:",e)}(await clients.matchAll()).forEach((e=>{e.postMessage({type:"SYNC_COMPLETE",success:!0})}))}catch(e){console.error("[Service Worker] Error in background sync:",e)}}function openDB(){return new Promise(((e,o)=>{const t=indexedDB.open("dicoding-story-db",1);t.onerror=()=>o(t.error),t.onsuccess=()=>e(t.result),t.onupgradeneeded=e=>{const o=e.target.result;o.objectStoreNames.contains("pending-stories")||o.createObjectStore("pending-stories",{keyPath:"id"}),o.objectStoreNames.contains("favorite-stories")||o.createObjectStore("favorite-stories",{keyPath:"id"})}}))}self.addEventListener("install",(e=>{console.log("[Service Worker] Installing..."),e.waitUntil(caches.open(CACHE_NAME).then((e=>(console.log("[Service Worker] Caching app shell"),e.addAll(urlsToCache)))).then((()=>(console.log("[Service Worker] Skip waiting"),self.skipWaiting()))))})),self.addEventListener("activate",(e=>{console.log("[Service Worker] Activating..."),e.waitUntil(caches.keys().then((e=>Promise.all(e.filter((e=>e!==CACHE_NAME&&e!==DATA_CACHE_NAME)).map((e=>(console.log("[Service Worker] Deleting old cache:",e),caches.delete(e))))))).then((()=>(console.log("[Service Worker] Claiming clients"),self.clients.claim()))))})),self.addEventListener("fetch",(e=>{const{request:o}=e;"https://story-api.dicoding.dev"!==new URL(o.url).origin?e.respondWith(caches.match(o).then((e=>e||fetch(o).then((e=>("GET"===o.method&&caches.open(CACHE_NAME).then((t=>{t.put(o,e.clone())})),e)))))):e.respondWith(caches.open(DATA_CACHE_NAME).then((e=>fetch(o).then((t=>("GET"===o.method&&e.put(o,t.clone()),t))).catch((()=>e.match(o).then((e=>e||new Response(JSON.stringify({error:!0,message:"You are offline. Please check your connection.",listStory:[]}),{headers:{"Content-Type":"application/json"},status:503}))))))))})),self.addEventListener("push",(e=>{console.log("[Service Worker] Push Received",e);let o={title:"Dicoding Story",options:{body:"You have a new notification",icon:"/images/icon-192x192.png",badge:"/images/icon-72x72.png",data:{url:"/"}}};if(e.data)try{const t=e.data.json();console.log("[Service Worker] Push data:",t),o={title:t.title||"Dicoding Story",options:{body:t.options?.body||t.body||"New story available!",icon:t.options?.icon||"/images/icon-192x192.png",badge:"/images/icon-72x72.png",tag:"dicoding-story-notification",requireInteraction:!1,actions:[{action:"view",title:"View Story",icon:"/images/icon-96x96.png"},{action:"close",title:"Close",icon:"/images/icon-96x96.png"}],data:{url:t.data?.url||"/",storyId:t.data?.storyId||null}}}}catch(e){console.error("[Service Worker] Error parsing push data:",e)}e.waitUntil(self.registration.showNotification(o.title,o.options))})),self.addEventListener("notificationclick",(e=>{console.log("[Service Worker] Notification clicked",e),e.notification.close();const o=e.notification.data?.url||"/";"close"!==e.action&&e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{for(const t of e)if(t.url===o&&"focus"in t)return t.focus();if(clients.openWindow)return clients.openWindow(o)})))})),self.addEventListener("sync",(e=>{console.log("[Service Worker] Background sync",e.tag),"sync-stories"===e.tag&&e.waitUntil(syncOfflineStories())}));